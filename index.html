<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yƒ±ƒüma (Kargir-Ah≈üap) Bina Veri Toplama</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .content {
            padding: 20px;
        }
        .step {
            display: none;
        }
        .step.active {
            display: block;
        }
        .step-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        #map {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .coords-display {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .camera-container {
            text-align: center;
        }
        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: none;
        }
        #canvas {
            display: none;
        }
        #photoPreview {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: none;
        }
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-drive {
            background: linear-gradient(135deg, #4285F4 0%, #34A853 100%);
            color: white;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .question-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .question-image {
            width: 100%;
            min-height: 150px;
            background: #e9ecef;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            padding: 10px;
            border: 2px solid #dee2e6;
        }
        .question-image img {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
        }
        .question-text {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
        }
        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .option-btn {
            padding: 15px 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 15px;
            font-weight: 500;
        }
        .option-btn.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .progress {
            background: #e9ecef;
            height: 8px;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
        }
        .data-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .data-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .data-item-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .data-item-info {
            font-size: 14px;
            color: #6c757d;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        .alert {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
        }
        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .login-screen {
            padding: 40px 20px;
            text-align: center;
        }
        .login-screen h2 {
            color: #333;
            margin-bottom: 10px;
        }
        .login-screen p {
            color: #6c757d;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .gps-button {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: all 0.3s;
            font-weight: bold;
        }
        .gps-button:hover {
            background: #667eea;
            color: white;
        }
        .gps-button:active {
            transform: scale(0.95);
        }
        #map-container {
            position: relative;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingText">Google Drive'a y√ºkleniyor...</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>üè¢ Yƒ±ƒüma (Kargir-Ah≈üap) Bina Veri Toplama</h1>
            <p>Saha Veri Toplama Sistemi - Google Drive Entegrasyonlu</p>
        </div>
        
        <div class="content">
            <!-- Giri≈ü Ekranƒ± -->
            <div class="step active" id="loginScreen">
                <div class="login-screen">
                    <h2>üìã Veri Toplama Ba≈ülangƒ±√ß</h2>
                    <p>L√ºtfen b√∂lge bilgilerinizi girin</p>
                    <div class="input-group">
                        <input type="text" id="userNameInput" placeholder="B√∂lge kodu veya adƒ±nƒ±z" />
                    </div>
                    <button class="btn btn-primary" onclick="startDataCollection()">Ba≈üla</button>
                </div>
            </div>

            <!-- Adƒ±m 1: Konum Se√ßimi -->
            <div class="step" id="step1">
                <div class="step-title">üìç Adƒ±m 1: Bina Konumunu Se√ßin</div>
                <div class="alert">Haritadan binanƒ±n konumuna tƒ±klayarak koordinatlarƒ± i≈üaretleyin</div>
                <div id="map-container">
                    <button class="gps-button" onclick="goToMyLocation()" title="Konumuma Git">üìç GPS</button>
                    <div id="map"></div>
                </div>
                <div class="coords-display" id="coordsDisplay">
                    Konum se√ßilmedi
                </div>
                <button class="btn btn-primary" onclick="nextStep()" id="nextBtn1" disabled>Devam Et</button>
            </div>

            <!-- Adƒ±m 2: Fotoƒüraf √áekimi -->
            <div class="step" id="step2">
                <div class="step-title">üì∏ Adƒ±m 2: Bina Fotoƒürafƒ± √áekin</div>
                <div class="camera-container">
                    <video id="video" autoplay playsinline></video>
                    <img id="photoPreview" />
                    <canvas id="canvas"></canvas>
                    <button class="btn btn-primary" onclick="startCamera()" id="startCameraBtn">Kamerayƒ± A√ß</button>
                    <button class="btn btn-success" onclick="takePhoto()" id="takePhotoBtn" style="display:none;">Fotoƒüraf √áek</button>
                    <button class="btn btn-secondary" onclick="retakePhoto()" id="retakeBtn" style="display:none;">Yeniden √áek</button>
                </div>
                <button class="btn btn-primary" onclick="nextStep()" id="nextBtn2" disabled style="margin-top:10px;">Devam Et</button>
                <button class="btn btn-secondary" onclick="prevStep()">Geri</button>
            </div>

            <!-- Adƒ±m 3: Sorular -->
            <div class="step" id="step3">
                <div class="step-title">üìã Adƒ±m 3: Deƒüerlendirme Sorularƒ±</div>
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                </div>
                
                <div id="questionsContainer"></div>
                
                <button class="btn btn-primary" onclick="nextStep()" id="nextBtn3" disabled>Devam Et</button>
                <button class="btn btn-secondary" onclick="prevStep()">Geri</button>
            </div>

            <!-- Adƒ±m 4: Kaydetme -->
            <div class="step" id="step4">
                <div class="step-title">‚úÖ Kaydet ve G√∂nder</div>
                <div class="alert alert-success">Veriler ba≈üarƒ±yla kaydedildi! ≈ûimdi Google Drive'a g√∂nderebilir veya yeni bina ekleyebilirsiniz.</div>
                
                <button class="btn btn-drive" onclick="uploadToDrive()">üì§ Google Drive'a G√∂nder</button>
                <button class="btn btn-success" onclick="saveAndNew()">Yeni Bina Ekle</button>
                <button class="btn btn-primary" onclick="viewData()">Toplanan Verileri G√∂r</button>
            </div>

            <!-- Adƒ±m 5: Veri Listesi -->
            <div class="step" id="step5">
                <div class="step-title">üìä Toplanan Veriler</div>
                <div id="dataList" class="data-list"></div>
                <button class="btn btn-drive" onclick="uploadToDrive()">üì§ T√ºm√ºn√º Drive'a G√∂nder</button>
                <button class="btn btn-success" onclick="saveAndNew()">Yeni Bina Ekle</button>
            </div>
        </div>
    </div>

    <script>
        // Google Drive API Ayarlarƒ±
        const CLIENT_ID = '384693908039-8v2so7u7ktn33q4abenurdbg4vcuddm4.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAyTA6cKkHfKlo6R3QbeNMCP3q7fjnMdhI';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;

        // Global deƒüi≈ükenler
        let map, marker, userLocationMarker;
        let currentData = {
            lat: null,
            lng: null,
            photo: null,
            answers: {},
            datetime: null,
            userName: ''
        };
        let allData = [];
        let currentStep = 'login';
        let savedMarkers = [];
        let stream = null;
        let userName = '';
        let myLocation = null;

        // 12 Soru
        const questions = [
            {
                id: 1,
                text: "Yapƒ± kullanƒ±m amacƒ±",
                options: ["Konut", "Konut+Ticaret", "Ticaret", "Sanayi", "Kamu", "Metruk"],
                helpImage: null
            },
            {
                id: 2,
                text: "Mevcut hasar durumu",
                options: ["Var", "Yok"],
                helpImage: null
            },
            {
                id: 3,
                text: "Malzeme kalitesi",
                options: ["ƒ∞yi", "Orta", "K√∂t√º"],
                helpImage: null
            },
            {
                id: 4,
                text: "√áatƒ± malzemesi",
                options: ["Kiremit", "Beton", "Sac", "Toprak"],
                helpImage: null
            },
            {
                id: 5,
                text: "Yapƒ± t√ºr√º ne?",
                options: ["Donatƒ±sƒ±z yƒ±ƒüma", "Karma(beton √ßer√ßeveli)", "Donatƒ±lƒ± Yƒ±ƒüma", "Ku≈üatƒ±lmƒ±≈ü Yƒ±ƒüma"],
                helpImage: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEik_dIKgu18u_RXRD8m40Of5Bv6DYNQu_rgaaTnTqTt_fQv_PJqlahZ_LOCsdsHFXUbOJuxT3Igf3hApBTq0Gk30rulAmqmPm4H4lXV1QCD-Dq2PGN4jO-ZxGOYrGkngbsOKXEanTlFRahb98FEaGtCJtK-qlHsKmkPjB-5mrKLedp4UFoch2nIN49EQwo/s320/yapituru.png"
            },
            {
                id: 6,
                text: "Zayƒ±f kat var mƒ±?",
                options: ["Yok", "Var"],
                helpImage: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhMXmT0-cIdqvK3zIDly3C2UaUegkjDP6T-CEAY3gQZdoewqKMFXJ4Qz7PQbYRGjAPrUeKAVeXqCVa9WIHn0_ws4-gSnRxWQAhhNLUaRGVLZxYGW52kMyf96pXJGC7djT1598ykUt29L9Khkln1tm2-axr1gThfq9GkVIh0yxiQxB4A2cddHCgZnFI4C-o/s320/yumusakkat.png"
            },
            {
                id: 7,
                text: "Serbest kat adedi",
                options: ["1", "2", "3", "4", "5"],
                helpImage: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgZuxmfibdFI1gvS5Mm5Wab-xUS3mlJ-i1bwJnbypA8p8yZnbcypv6kjQHbga3xtQ1KZMeYFMz0k9XW1QsgStZge63_AwZgQZxbUNP9rM1iFh9i8OP6M08NVDqJ1xG1Qe6M3GbSBLIxStSZtHcLnIVIglaKemXle7jK9iy2strhP3hNGS5OcSyyLk2e9A8/s320/serbestkatadedi.png"
            },
            {
                id: 8,
                text: "D√º≈üey d√ºzensizlik durumu",
                options: ["D√ºzenli", "Az d√ºzenli", "D√ºzensiz"],
                helpImage: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjSnl7TH4x2mmSOJ6kSLJqtzNZEXAAO4Uuoxixz7sh0ik_NTfUYOXdbhYZi5mUW5Q6bgbmDbLbEcHbB5pCtJ07W8IXSJb1IRZiFkuLdjmC-tF9GSsn2Cu5Nd2oaUoGJH2kp9P_uUFaeI4GgvrJQKufirNJXwqdGhk1Kj_OoOxhNqfTqvOgpJLCvRbiQUHY/s320/binad%C3%BCseyboslukd%C3%BCzeni.png"
            },
            {
                id: 9,
                text: "Cepheye g√∂re kat farklƒ±lƒ±ƒüƒ± var mƒ±?",
                options: ["Yok", "Var"],
                helpImage: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjWbZubWKV_urF19LfwR9-WsGfgqShK-ABHh2fR_C9UxSZK7VJQWKjAxaTwAT0_3Gc1y7dzG6lepWj0ZpDsUG680q4N4eVIcoG7oIiZm9WkKIbhwVx2rcBwm3e9vV2RbNqByvGKlWVl9Ij3oipBff99m9qLquTtjPdaOkqOgWZL-03ptjvzr8-xDF09QOU/s320/katfarkliligi.png"
            },
            {
                id: 10,
                text: "Planda d√ºzensizlik var mƒ±?",
                options: ["D√ºzenli", "D√ºzensiz", "A≈üƒ±rƒ± d√ºzensiz"],
                helpImage: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjXkz0UWJSYwfCLHji8A620vmMNFXrY605gJuWuQanNNl0FX2ndKKNXXoPzzm19x0QMpBbKIXmxbWRWxFwUNQeTb5LZzg-RPSoHOiaqSArOx0CsOfsFvgCyyBPQvWMaO2diVF2wZe2AVONZsxScb9vOu6VRtGGD0xJWO7Lxt8zZa-o29sui40oyr2Pn76M/s320/plandaduzensizlik.png"
            },
            {
                id: 11,
                text: "Yapƒ± nizam durumu",
                options: ["Ayrƒ±k", "Biti≈üik", "K√∂≈üede biti≈üik"],
                helpImage: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi7ArTePp_fcavw8ZXSYdbGkMLnBaUvJtYgI13DhbwDX9rSTQ5j4m8IBEODMKCcJ0ph2QbEU5tKC33yukkgeKjZsW3l_e-c4zx0XBYDsdHannU8ATW8ZlPKeAM2GBEUYU5chLSl7zi5V0ce8rpUuCVMIfFADKb9YrUI0HlwBa6gpB3-OE_-50au8r_Exzs/s1600/yapinizam.png"
            },
            {
                id: 12,
                text: "Biti≈üik binalarla d√∂≈üeme seviyesi",
                options: ["Aynƒ±", "Farklƒ±"],
                helpImage: "https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiv8-mSf9-KG_gZeMKgpCkMBvrweX7F7j6iWhNv4d4ajbIdNuh-HTY_lvys4Rda7JI5R6E5yKgszhLh4TJVRZJNEZ93MCpS-xbZEbxVyv-QTpf0Iymk0GtJSTbzwP1zjSvFTROjJ9V7YnKzKUau11zF39MHMPkqLBAerXICrpagJ0u3_0aezVXlC26nxpc/s320/dosemeseviyesi.png"
            }
        ];

        // Google API Ba≈ülatma
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
        }

        function startDataCollection() {
            const nameInput = document.getElementById('userNameInput');
            const name = nameInput.value.trim();
            
            if (name === '') {
                alert('L√ºtfen b√∂lge bilgilerinizi giriniz');
                nameInput.focus();
                return;
            }
            
            userName = name;
            currentData.userName = userName;
            
            document.getElementById('loginScreen').classList.remove('active');
            currentStep = 1;
            document.getElementById('step1').classList.add('active');
            
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    showAllSavedBuildings();
                    if (myLocation) {
                        map.setView([myLocation.lat, myLocation.lng], 18);
                    }
                }
            }, 100);
        }

        function initMap() {
            map = L.map('map').setView([37.1494, 30.5433], 15);
            
            const googleHybrid = L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0','mt1','mt2','mt3'],
                attribution: '¬© Google Hybrid'
            });

            const googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0','mt1','mt2','mt3'],
                attribution: '¬© Google'
            });

            const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles ¬© Esri',
                maxZoom: 19
            });

            const street = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            });

            googleHybrid.addTo(map);

            const baseMaps = {
                "üõ∞Ô∏è Google Hybrid (√ñnerilen)": googleHybrid,
                "üõ∞Ô∏è Google Uydu": googleSat,
                "üõ∞Ô∏è Esri Uydu": esriSat,
                "üó∫Ô∏è Sokak Haritasƒ±": street
            };
            L.control.layers(baseMaps).addTo(map);
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        myLocation = { lat, lng };
                        map.setView([lat, lng], 18);
                        
                        if (userLocationMarker) {
                            map.removeLayer(userLocationMarker);
                        }
                        userLocationMarker = L.circleMarker([lat, lng], {
                            color: '#4285F4',
                            fillColor: '#4285F4',
                            fillOpacity: 0.8,
                            radius: 8
                        }).addTo(map).bindPopup('Konumunuz');
                    },
                    function(error) {
                        console.warn('GPS eri≈üimi ba≈üarƒ±sƒ±z:', error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            }

            map.on('click', function(e) {
                if (marker) {
                    map.removeLayer(marker);
                }
                marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
                currentData.lat = e.latlng.lat;
                currentData.lng = e.latlng.lng;
                document.getElementById('coordsDisplay').innerHTML = 
                    `<strong>Se√ßilen Konum:</strong><br>Enlem: ${e.latlng.lat.toFixed(6)}, Boylam: ${e.latlng.lng.toFixed(6)}`;
                document.getElementById('nextBtn1').disabled = false;
            });
        }

        function goToMyLocation() {
            if (myLocation) {
                map.setView([myLocation.lat, myLocation.lng], 18);
            } else {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            myLocation = { lat, lng };
                            
                            map.setView([lat, lng], 18);
                            
                            if (userLocationMarker) {
                                map.removeLayer(userLocationMarker);
                            }
                            userLocationMarker = L.circleMarker([lat, lng], {
                                color: '#4285F4',
                                fillColor: '#4285F4',
                                fillOpacity: 0.8,
                                radius: 8
                            }).addTo(map).bindPopup('Konumunuz');
                        },
                        function(error) {
                            alert('GPS konumu alƒ±namadƒ±. L√ºtfen konum izinlerini kontrol edin.');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 5000,
                            maximumAge: 0
                        }
                    );
                } else {
                    alert('GPS desteƒüi mevcut deƒüil');
                }
            }
        }

        function addSavedBuildingMarker(lat, lng, buildingNumber) {
            const greenIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: #28a745; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${buildingNumber}</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const savedMarker = L.marker([lat, lng], { icon: greenIcon })
                .addTo(map)
                .bindPopup(`<b>Bina ${buildingNumber}</b><br>Kaydedildi ‚úì`);
            
            savedMarkers.push(savedMarker);
        }

        function showAllSavedBuildings() {
            savedMarkers.forEach(m => map.removeLayer(m));
            savedMarkers = [];
            
            allData.forEach((data, index) => {
                addSavedBuildingMarker(data.lat, data.lng, index + 1);
            });
        }
        
        async function startCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('Kamera desteƒüi mevcut deƒüil. L√ºtfen HTTPS baƒülantƒ±sƒ± kullanƒ±n.');
                    return;
                }
                
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    } 
                });
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.style.display = 'block';
                document.getElementById('startCameraBtn').style.display = 'none';
                document.getElementById('takePhotoBtn').style.display = 'block';
            } catch (err) {
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    alert('Kamera eri≈üimi reddedildi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan kamera iznini verin.');
                } else if (err.name === 'NotFoundError') {
                    alert('Kamera bulunamadƒ±.');
                } else {
                    alert('Kamera eri≈üimi ba≈üarƒ±sƒ±z: ' + err.message);
                }
                console.error('Kamera hatasƒ±:', err);
            }
        }

        function takePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const preview = document.getElementById('photoPreview');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            currentData.photo = canvas.toDataURL('image/jpeg', 0.6);
            preview.src = currentData.photo;
            preview.style.display = 'block';
            
            video.style.display = 'none';
            document.getElementById('takePhotoBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'block';
            document.getElementById('nextBtn2').disabled = false;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        }

        function retakePhoto() {
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('startCameraBtn').style.display = 'block';
            document.getElementById('nextBtn2').disabled = true;
            currentData.photo = null;
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            questions.forEach((q, index) => {
                const card = document.createElement('div');
                card.className = 'question-card';
                
                let imageHtml = '';
                if (q.helpImage) {
                    imageHtml = `<div class="question-image"><img src="${q.helpImage}" alt="Yardƒ±mcƒ± g√∂rsel" /></div>`;
                }
                
                card.innerHTML = `
                    ${imageHtml}
                    <div class="question-text">${index + 1}. ${q.text}</div>
                    <div class="options">
                        ${q.options.map(opt => 
                            `<button class="option-btn" onclick="selectAnswer(${q.id}, '${opt}')">${opt}</button>`
                        ).join('')}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function selectAnswer(questionId, answer) {
            currentData.answers[questionId] = answer;
            
            event.target.parentElement.querySelectorAll('.option-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            const progress = (Object.keys(currentData.answers).length / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            if (Object.keys(currentData.answers).length === questions.length) {
                document.getElementById('nextBtn3').disabled = false;
            }
        }

        function nextStep() {
            document.getElementById('step' + currentStep).classList.remove('active');
            currentStep++;
            
            if (currentStep === 3) {
                renderQuestions();
            }
            
            if (currentStep === 4) {
                saveCurrentData();
            }
            
            document.getElementById('step' + currentStep).classList.add('active');
        }

        function prevStep() {
            document.getElementById('step' + currentStep).classList.remove('active');
            currentStep--;
            document.getElementById('step' + currentStep).classList.add('active');
        }

        function saveCurrentData() {
            currentData.datetime = new Date().toLocaleString('tr-TR');
            currentData.userName = userName;
            allData.push({...currentData});
            
            addSavedBuildingMarker(currentData.lat, currentData.lng, allData.length);
            
            console.log('Veri kaydedildi:', currentData);
        }

        function saveAndNew() {
            currentData = {
                lat: null,
                lng: null,
                photo: null,
                answers: {},
                datetime: null,
                userName: userName
            };
            
            if (marker) {
                map.removeLayer(marker);
            }
            document.getElementById('coordsDisplay').innerHTML = 'Konum se√ßilmedi';
            document.getElementById('nextBtn1').disabled = true;
            
            document.getElementById('photoPreview').style.display = 'none';
            document.getElementById('startCameraBtn').style.display = 'block';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('takePhotoBtn').style.display = 'none';
            document.getElementById('nextBtn2').disabled = true;
            
            document.getElementById('nextBtn3').disabled = true;
            document.getElementById('progressBar').style.width = '0%';
            
            document.getElementById('step' + currentStep).classList.remove('active');
            currentStep = 1;
            document.getElementById('step1').classList.add('active');
            
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    showAllSavedBuildings();
                    if (myLocation) {
                        map.setView([myLocation.lat, myLocation.lng], 18);
                    }
                }
            }, 100);
        }

        function viewData() {
            const dataList = document.getElementById('dataList');
            
            if (allData.length === 0) {
                dataList.innerHTML = '<div class="empty-state">Hen√ºz veri toplanmadƒ±</div>';
            } else {
                dataList.innerHTML = allData.map((data, index) => `
                    <div class="data-item">
                        <div class="data-item-header">Bina ${index + 1}</div>
                        <div class="data-item-info">
                            <strong>Kullanƒ±cƒ±:</strong> ${data.userName}<br>
                            <strong>Tarih:</strong> ${data.datetime}<br>
                            <strong>Konum:</strong> ${data.lat.toFixed(6)}, ${data.lng.toFixed(6)}<br>
                            <strong>Cevaplar:</strong> ${Object.values(data.answers).join(', ')}
                        </div>
                    </div>
                `).join('');
            }
            
            document.getElementById('step' + currentStep).classList.remove('active');
            currentStep = 5;
            document.getElementById('step5').classList.add('active');
        }

        async function uploadToDrive() {
            if (allData.length === 0) {
                alert('Hen√ºz veri yok!');
                return;
            }

            if (!gapiInited || !gisInited) {
                alert('Google Drive y√ºkleniyor, l√ºtfen bekleyin...');
                return;
            }

            showLoading('Google hesabƒ±nƒ±za giri≈ü yapƒ±lƒ±yor...');

            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    hideLoading();
                    throw (resp);
                }
                accessToken = gapi.client.getToken().access_token;
                await uploadFilesToDrive();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        async function uploadFilesToDrive() {
            try {
                showLoading('"Yigma" ana klas√∂r√º kontrol ediliyor...');
                
                const timestamp = new Date().toISOString().slice(0,10);
                const safeUserName = userName.replace(/\s+/g, '_');
                const mainFolderName = `${safeUserName}_${timestamp}`;
                
                // "Yigma" klas√∂r√ºn√º bul veya olu≈ütur
                const yigmaFolder = await findOrCreateFolder('Yigma', null);
                
                if (!yigmaFolder || !yigmaFolder.id) {
                    throw new Error('Yigma klas√∂r√º olu≈üturulamadƒ±');
                }
                
                showLoading('Kullanƒ±cƒ± klas√∂r√º olu≈üturuluyor...');
                
                // Kullanƒ±cƒ± klas√∂r√ºn√º yigma klas√∂r√º i√ßinde olu≈ütur
                const mainFolder = await createFolder(mainFolderName, yigmaFolder.id);
                
                if (!mainFolder || !mainFolder.id) {
                    throw new Error('Kullanƒ±cƒ± klas√∂r√º olu≈üturulamadƒ±');
                }
                
                // Fotoƒüraflar klas√∂r√ºn√º olu≈ütur
                showLoading('Fotoƒüraflar klas√∂r√º olu≈üturuluyor...');
                const photosFolder = await createFolder('fotograflar', mainFolder.id);
                
                // Excel dosyasƒ± olu≈ütur
                showLoading('Excel dosyasƒ± hazƒ±rlanƒ±yor...');
                const ws_data = [
                    ['Bina No', 'Kullanƒ±cƒ±', 'Tarih-Saat', 'Enlem', 'Boylam', ...questions.map(q => q.text), 'Fotoƒüraf Dosyasƒ±']
                ];
                
                allData.forEach((data, index) => {
                    const row = [
                        index + 1,
                        data.userName || userName,
                        data.datetime,
                        data.lat,
                        data.lng,
                        ...questions.map(q => data.answers[q.id] || '-'),
                        data.photo ? `fotograflar/bina_${index + 1}.jpg` : 'Yok'
                    ];
                    ws_data.push(row);
                });
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                XLSX.utils.book_append_sheet(wb, ws, 'Bina Verileri');
                const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                
                // Excel dosyasƒ±nƒ± y√ºkle
                showLoading('Excel dosyasƒ± y√ºkleniyor...');
                const excelBlob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                await uploadFile(excelBlob, `${mainFolderName}.xlsx`, mainFolder.id);
                
                // Fotoƒüraflarƒ± y√ºkle
                let uploadedPhotos = 0;
                const totalPhotos = allData.filter(d => d.photo).length;
                for (let i = 0; i < allData.length; i++) {
                    if (allData[i].photo) {
                        showLoading(`Fotoƒüraf y√ºkleniyor... (${uploadedPhotos + 1}/${totalPhotos})`);
                        const base64Data = allData[i].photo.split(',')[1];
                        const blob = base64ToBlob(base64Data, 'image/jpeg');
                        await uploadFile(blob, `bina_${i + 1}.jpg`, photosFolder.id);
                        uploadedPhotos++;
                    }
                }
                
                hideLoading();
                alert(`‚úÖ Ba≈üarƒ±yla Google Drive'a y√ºklendi!\n\nüìÅ Klas√∂r: Yigma/${mainFolderName}\nüìä Excel dosyasƒ±: 1 adet\nüì∏ Fotoƒüraf: ${uploadedPhotos} adet\n\nGoogle Drive'ƒ±nƒ±zƒ± kontrol edin!`);
                
            } catch (error) {
                hideLoading();
                console.error('Y√ºkleme hatasƒ±:', error);
                alert('‚ùå Y√ºkleme sƒ±rasƒ±nda hata olu≈ütu: ' + error.message);
            }
        }

        async function findOrCreateFolder(folderName, parentId) {
            try {
                let query = `name='${folderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
                if (parentId) {
                    query += ` and '${parentId}' in parents`;
                } else {
                    query += ` and 'root' in parents`;
                }
                
                const searchResponse = await fetch(
                    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`, 
                    {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken
                        }
                    }
                );
                
                if (!searchResponse.ok) {
                    console.error('Arama hatasƒ±:', await searchResponse.text());
                    return await createFolder(folderName, parentId);
                }
                
                const searchResult = await searchResponse.json();
                
                if (searchResult.files && searchResult.files.length > 0) {
                    console.log('Mevcut klas√∂r bulundu:', searchResult.files[0]);
                    return searchResult.files[0];
                }
                
                console.log('Yeni klas√∂r olu≈üturuluyor:', folderName);
                return await createFolder(folderName, parentId);
                
            } catch (error) {
                console.error('findOrCreateFolder hatasƒ±:', error);
                return await createFolder(folderName, parentId);
            }
        }

        async function createFolder(folderName, parentId) {
            const metadata = {
                name: folderName,
                mimeType: 'application/vnd.google-apps.folder'
            };
            
            if (parentId) {
                metadata.parents = [parentId];
            }
            
            const response = await fetch('https://www.googleapis.com/drive/v3/files?fields=id,name', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(metadata)
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Klas√∂r olu≈üturma hatasƒ±:', errorText);
                throw new Error('Klas√∂r olu≈üturulamadƒ±: ' + errorText);
            }
            
            return await response.json();
        }

        async function uploadFile(blob, fileName, parentId) {
            const metadata = {
                name: fileName,
                parents: [parentId]
            };
            
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', blob);
            
            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                },
                body: form
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Dosya y√ºkleme hatasƒ±:', errorText);
                throw new Error('Dosya y√ºklenemedi: ' + errorText);
            }
            
            return await response.json();
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        function showLoading(text) {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        window.onload = function() {
            initMap();
            gapiLoaded();
            gisLoaded();
        };
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>